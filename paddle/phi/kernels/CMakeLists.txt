set(kernel_declare_file
    ${PADDLE_BINARY_DIR}/paddle/phi/kernels/declarations.h.tmp
    CACHE INTERNAL "declarations.h file")
set(kernel_declare_file_final
    ${PADDLE_BINARY_DIR}/paddle/phi/kernels/declarations.h)
file(
  WRITE ${kernel_declare_file}
  "// Generated by the paddle/phi/kernels/CMakeLists.txt.  DO NOT EDIT!\n\n#pragma once\n\n"
)
file(APPEND ${kernel_declare_file}
     "#include \"paddle/phi/core/kernel_registry.h\"\n\n")
set(kernel_declare_file_prune
    ${PADDLE_BINARY_DIR}/paddle/phi/kernels/declarations.h.prune
    CACHE INTERNAL "declarations.h file")

# phi functors and functions called by kernels
add_subdirectory(funcs)

# kernel autotune
add_subdirectory(autotune)

copy_if_different(${kernel_declare_file} ${kernel_declare_file_final})

file(GLOB kernel_h "*.h" "selected_rows/*.h" "sparse/*.h" "strings/*.h")
file(GLOB kernel_impl_h "impl/*.h" "selected_rows/impl/*.h")
file(GLOB kernel_primitive_h "primitive/*.h")

# fusion ops would be included here
file(
  GLOB kernel_cu
  RELATIVE "${CMAKE_CURRENT_SOURCE_DIR}"
  "gpu/*.cu"
  "gpu/*.cu.cc"
  "gpudnn/*.cu"
  "kps/*.cu"
  "legacy/kps/*.cu"
  "legacy/gpu/*.cu"
  "selected_rows/gpu/*.cu"
  "sparse/gpu/*.cu"
  "strings/gpu/*.cu"
  "fusion/gpu/*.cu")

# FIXME(@MTAI): compilation error will occur when compiling the following files.
# This need to be fixed later.
if(WITH_MUSA)
  list(
    REMOVE_ITEM
    kernel_cu
    "fusion/gpu/fused_softmax_mask_grad_kernel.cu"
    "fusion/gpu/fused_softmax_mask_kernel.cu"
    "gpu/batch_norm_grad_kernel.cu"
    "gpu/batch_norm_kernel.cu"
    "gpu/cholesky_grad_kernel.cu"
    "gpu/cholesky_solve_grad_kernel.cu"
    "gpu/conv_grad_kernel.cu"
    "gpu/cross_entropy_grad_kernel.cu"
    "gpu/cross_entropy_kernel.cu"
    "gpu/conv_transpose_grad_kernel.cu"
    "gpu/conv_transpose_kernel.cu"
    "gpu/cudnn_lstm_grad_kernel.cu"
    "gpu/cudnn_lstm_kernel.cu"
    "gpu/depthwise_conv_grad_kernel.cu"
    "gpu/depthwise_conv_kernel.cu"
    "gpu/dist_kernel.cu"
    "gpu/elementwise_divide_grad_kernel.cu"
    "gpu/elementwise_grad_kernel.cu"
    "gpu/elementwise_multiply_grad_kernel.cu"
    "gpu/erfinv_kernel.cu"
    "gpu/exponential_kernel.cu"
    "gpu/fft_grad_kernel.cu"
    "gpu/fft_kernel.cu"
    "gpu/fused_softmax_mask_grad_kernel.cu"
    "gpu/gaussian_kernel.cu"
    "gpu/gelu_grad_kernel.cu"
    "gpu/gelu_kernel.cu"
    "gpu/histogram_kernel.cu"
    "gpu/instance_norm_grad_kernel.cu"
    "gpu/instance_norm_kernel.cu"
    "gpu/interpolate_grad_kernel.cu"
    "gpu/kthvalue_grad_kernel.cu"
    "gpu/kthvalue_kernel.cu"
    "gpu/layer_norm_grad_kernel.cu"
    "gpu/layer_norm_kernel.cu"
    "gpu/llm_int8_mat_mul_kernel.cu"
    "gpu/log_softmax_grad_kernel.cu"
    "gpu/log_softmax_kernel.cu"
    "gpu/lstsq_kernel.cu"
    "gpu/nanmedian_kernel.cu"
    "gpu/rnn_grad_kernel.cu.cc"
    "gpu/rnn_kernel.cu.cc"
    "gpu/slogdeterminant_grad_kernel.cu"
    "gpu/softmax_grad_kernel.cu"
    "gpu/softmax_kernel.cu"
    "gpu/solve_grad_kernel.cu"
    "gpu/solve_kernel.cu"
    "gpu/spectral_norm_grad_kernel.cu"
    "gpu/spectral_norm_kernel.cu"
    "gpu/stft_kernel.cu"
    "gpu/svd_grad_kernel.cu"
    "gpu/top_k_grad_kernel.cu"
    "gpu/top_k_kernel.cu"
    "gpu/truncated_gaussian_random_kernel.cu"
    "gpudnn/softmax_grad_kernel.cu"
    "gpudnn/pool_grad_kernel.cu"
    "sparse/gpu/softmax_grad_kernel.cu"
    "sparse/gpu/softmax_kernel.cu"
    "sparse/gpu/conv_kernel.cu"
    "sparse/gpu/pool_kernel.cu"
    "strings/gpu/strings_copy_kernel.cu"
    "strings/gpu/strings_lower_upper_kernel.cu")
endif()

if(APPLE OR WIN32)
  list(REMOVE_ITEM kernel_cu "fusion/gpu/fusion_group_kernel.cu")
endif()

if(DEFINED REDUCE_INFERENCE_LIB_SIZE)
  list(FILTER kernel_cu EXCLUDE REGEX ".*_grad_kernel\\.cc$")
  list(FILTER kernel_cu EXCLUDE REGEX ".*_grad_kernel\\.cu$")
endif()

if(WITH_CUTLASS)
  execute_process(
    COMMAND ${CMAKE_COMMAND} -E make_directory
            "${CMAKE_CURRENT_SOURCE_DIR}/fusion/cutlass/conv2d/generated"
    COMMAND ${PYTHON_EXECUTABLE} "conv2d_bias_act.py"
    COMMAND ${PYTHON_EXECUTABLE} "conv2d_bias_residual.py"
    COMMAND ${PYTHON_EXECUTABLE} "conv2d_depthwise_bias_act.py"
    WORKING_DIRECTORY "${CMAKE_CURRENT_SOURCE_DIR}/fusion/cutlass/conv2d")

  execute_process(
    COMMAND
      ${PYTHON_EXECUTABLE}
      ${PADDLE_SOURCE_DIR}/paddle/phi/kernels/fusion/cutlass/memory_efficient_attention/generate_kernels.py
      --cuda_arch "${NVCC_ARCH_BIN}"
    RESULT_VARIABLE memory_efficient_attention_gen_res)

  if(NOT memory_efficient_attention_gen_res EQUAL 0)
    message(
      FATAL_ERROR
        "The memory efficient attention kernel generation errors with NVCC_ARCH_BIN=${NVCC_ARCH_BIN}"
    )
  endif()

  file(
    GLOB cutlass_cu
    RELATIVE "${CMAKE_CURRENT_SOURCE_DIR}"
    "fusion/cutlass/conv2d/generated/*.cu" "fusion/cutlass/conv2d/*.cu"
    "fusion/cutlass/*.cu"
    "fusion/cutlass/memory_efficient_attention/autogen/impl/*.cu")
  list(APPEND kernel_cu ${cutlass_cu})
endif()

set(cc_search_pattern
    "*.cc"
    "cpu/*.cc"
    "legacy/*.cc"
    "legacy/cpu/*.cc"
    "selected_rows/*.cc"
    "selected_rows/cpu/*.cc"
    "sparse/*.cc"
    "sparse/cpu/*.cc"
    "legacy/*.cc"
    "legacy/cpu/*.cc"
    "strings/*.cc"
    "strings/cpu/*.cc"
    "fusion/*.cc"
    "fusion/cpu/*.cc")

if(WITH_MKLDNN)
  set(cc_search_pattern ${cc_search_pattern} "legacy/onednn/*.cc" "onednn/*.cc"
                        "fusion/onednn/*.cc")
endif()

file(
  GLOB kernel_cc
  RELATIVE "${CMAKE_CURRENT_SOURCE_DIR}"
  ${cc_search_pattern})

if(DEFINED REDUCE_INFERENCE_LIB_SIZE)
  list(FILTER kernel_cc EXCLUDE REGEX ".*_grad_kernel\\.cc$")
endif()

file(
  GLOB kernel_xpu
  RELATIVE "${CMAKE_CURRENT_SOURCE_DIR}"
  "xpu/*.cc" "legacy/xpu/*.cc" "selected_rows/xpu/*.cc" "fusion/xpu/*.cc"
  "sparse/xpu/*.cc")

if(WITH_GPU
   OR WITH_ROCM
   OR WITH_MUSA)
  collect_srcs(kernels_srcs SRCS ${kernel_cu})
  kernel_declare("${kernel_cu}")
endif()

if(WITH_XPU)
  if(WITH_XPU_KP)
    file(COPY ${CMAKE_CURRENT_SOURCE_DIR}/kps/
         DESTINATION ${CMAKE_CURRENT_BINARY_DIR}/kps/)
    file(COPY ${CMAKE_CURRENT_SOURCE_DIR}/legacy/kps/
         DESTINATION ${CMAKE_CURRENT_BINARY_DIR}/kps/)
    file(GLOB kernel_xpu_kps "${CMAKE_CURRENT_BINARY_DIR}/kps/*.cu")
    foreach(kernel ${kernel_xpu_kps})
      get_filename_component(name ${kernel} NAME_WE)
      file(RENAME ${kernel} "${CMAKE_CURRENT_BINARY_DIR}/kps/${name}.kps")
    endforeach()
    file(GLOB kernel_xpu_kps "${CMAKE_CURRENT_BINARY_DIR}/kps/*.kps")
    collect_generated_srcs(kernels_srcs SRCS ${kernel_xpu_kps})

    foreach(kernel ${kernel_cc})
      configure_file(${CMAKE_CURRENT_SOURCE_DIR}/${kernel}
                     ${CMAKE_CURRENT_BINARY_DIR}/${kernel} COPYONLY)
    endforeach()
    file(GLOB_RECURSE kernel_xpu_cc "${CMAKE_CURRENT_BINARY_DIR}/*.cc")
    collect_generated_srcs(kernels_srcs SRCS ${kernel_xpu_cc})
    set(kernel_cc "")

  endif()
  collect_srcs(kernels_srcs SRCS ${kernel_xpu})
  kernel_declare("${kernel_xpu}")
  kernel_declare("${kernel_xpu_kps}")
  kernel_declare("${kernel_xpu_cc}")
endif()

collect_srcs(kernels_srcs SRCS ${kernel_cc})
kernel_declare("${kernel_cc}")

if(NOT "${KERNEL_LIST}" STREQUAL "")
  prune_declaration_h()
endif()
